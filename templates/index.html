<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bearing & Accessories Specification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #fafafa; margin: 2rem; }
    .card { background: white; padding: 2rem; border-radius: 8px; }
    .btn-primary { background-color: #0078d7; border: none; }
    .char-counter { text-align: right; font-size: 0.8em; color: gray; }
    .output-box {
      background: #f8f9fa; padding: 10px; border-radius: 5px;
      border: 1px solid #ddd; font-family: monospace;
    }
    table th, table td { vertical-align: middle !important; }
  </style>
</head>
<body>
  <div class="container">
    <img src="#" alt="Company Logo" class="mb-3">
    <h3><b>Bearing & Accessories Specification</b></h3>

    <div class="card mb-4">
      <form id="bearingForm">
        <div class="mb-3">
          <label class="form-label">Category:</label>
          <input type="text" class="form-control" value="Bearing" readonly>
        </div>

        <h5>Bearing Details</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label>Bearing Type:</label>
            <select class="form-select" id="bearing_type">
              <option>Deep Groove Ball Bearing</option>
              <option>Cylindrical Roller Bearing</option>
              <option>Tapered Roller Bearing</option>
            </select>
          </div>
          <div class="col-md-4">
            <label>Bearing Sub-Type:</label>
            <select class="form-select" id="bearing_sub_type">
              <option>6000 Series</option>
              <option>6200 Series</option>
              <option>6300 Series</option>
            </select>
          </div>
          <div class="col-md-4">
            <label>Bearing Number / Code:</label>
            <input type="text" class="form-control" id="bearing_number" maxlength="40">
            <div class="char-counter" id="charCount">0/40 characters</div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>Seals/Shields:</label>
            <select class="form-select" id="seals_shields">
              <option>OPEN (Default)</option>
              <option>ZZ</option>
              <option>2RS</option>
            </select>
          </div>
          <div class="col-md-4">
            <label>Other Suffixes:</label>
            <input type="text" class="form-control" id="other_suffixes" placeholder="e.g. TN9, P6">
          </div>
          <div class="col-md-4">
            <label>Make / Application (Optional):</label>
            <input type="text" class="form-control" id="make_application" placeholder="e.g. Toyota, SKF, Front Wheel Hub">
          </div>
        </div>

        <button type="button" class="btn btn-primary" id="generateBtn">Generate Name</button>
        <button type="reset" class="btn btn-secondary">Reset</button>
      </form>

      <div class="mt-4">
        <label>Generated Specification:</label>
        <div class="output-box" id="specOutput"></div>
      </div>

      <div class="mt-3">
        <label>Full Description:</label>
        <div class="output-box" id="descOutput"></div>
      </div>
    </div>

    <!-- Live Database Table -->
    <div class="card">
      <h5>ðŸ“‹ Saved Bearings</h5>
      <table class="table table-striped" id="bearingTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Sub-Type</th>
            <th>Number</th>
            <th>Seals</th>
            <th>Suffixes</th>
            <th>Application</th>
            <th>Generated Spec</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const numberInput = document.getElementById("bearing_number");
    const charCount = document.getElementById("charCount");

    numberInput.addEventListener("input", () => {
      charCount.textContent = `${numberInput.value.length}/40 characters`;
    });

    async function refreshTable() {
      const res = await fetch("/api/bearings");
      const data = await res.json();
      const tbody = document.querySelector("#bearingTable tbody");
      tbody.innerHTML = "";
      data.forEach(b => {
        const row = `<tr>
          <td>${b.id}</td>
          <td>${b.bearing_type}</td>
          <td>${b.bearing_sub_type}</td>
          <td>${b.bearing_number}</td>
          <td>${b.seals_shields}</td>
          <td>${b.other_suffixes}</td>
          <td>${b.make_application}</td>
          <td>${b.generated_specification}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    document.getElementById("generateBtn").addEventListener("click", async () => {
      const payload = {
        bearing_type: document.getElementById("bearing_type").value,
        bearing_sub_type: document.getElementById("bearing_sub_type").value,
        bearing_number: document.getElementById("bearing_number").value,
        seals_shields: document.getElementById("seals_shields").value,
        other_suffixes: document.getElementById("other_suffixes").value,
        make_application: document.getElementById("make_application").value
      };

      const res = await fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Bearing_Specifications.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        const data = await (await fetch("/api/latest")).json();
        document.getElementById("specOutput").textContent = data.spec;
        document.getElementById("descOutput").textContent = data.full_description;
      }

      refreshTable();
    });

    window.onload = refreshTable;
  </script>
</body>
</html>
